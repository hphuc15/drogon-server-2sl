<!DOCTYPE html>
<html lang="en">
<%c++ auto data=@@.get<std::vector<std::map<std::string, std::string>>>("data");%>

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sensor Data Dashboard</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background-color: #f5f9ff;
                color: #333;
                line-height: 1.6;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            header {
                text-align: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 2px solid #e0edff;
            }

            h1 {
                color: #2c5282;
                font-size: 28px;
                font-weight: 600;
            }

            .subtitle {
                color: #718096;
                margin-top: 5px;
                font-size: 14px;
            }

            .filter-section {
                background: white;
                padding: 25px;
                margin-bottom: 30px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                border: 1px solid #e2e8f0;
            }

            .filter-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }

            .filter-group {
                display: flex;
                flex-direction: column;
            }

            label {
                font-weight: 500;
                color: #4a5568;
                margin-bottom: 6px;
                font-size: 14px;
            }

            input,
            select {
                padding: 10px 12px;
                border: 1px solid #cbd5e0;
                border-radius: 4px;
                font-size: 14px;
                transition: border-color 0.2s;
            }

            input:focus,
            select:focus {
                outline: none;
                border-color: #4299e1;
                box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
            }

            .multiselect-container {
                position: relative;
            }

            .multiselect-header {
                padding: 10px 12px;
                border: 1px solid #cbd5e0;
                border-radius: 4px;
                background: white;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 14px;
            }

            .multiselect-header::after {
                content: "▼";
                font-size: 10px;
                color: #718096;
            }

            .multiselect-options {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #cbd5e0;
                border-top: none;
                border-radius: 0 0 4px 4px;
                z-index: 10;
                display: none;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            }

            .multiselect-options.active {
                display: block;
            }

            .multiselect-option {
                padding: 10px 12px;
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            .multiselect-option:hover {
                background-color: #f7fafc;
            }

            .multiselect-option input[type="checkbox"] {
                margin: 0;
            }

            .button-group {
                display: flex;
                gap: 12px;
                justify-content: center;
                padding-top: 20px;
                border-top: 1px solid #e2e8f0;
            }

            .btn {
                padding: 10px 24px;
                border: none;
                border-radius: 4px;
                font-weight: 500;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-primary {
                background-color: #4299e1;
                color: white;
            }

            .btn-primary:hover {
                background-color: #3182ce;
            }

            .btn-export {
                background-color: #2eb576;
                color: white;
            }

            .btn-export:hover {
                background-color: #38a169;
            }

            .btn-secondary {
                background-color: #e2e8f0;
                color: #4a5568;
            }

            .btn-secondary:hover {
                background-color: #cbd5e0;
            }

            .table-container {
                background: white;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                border: 1px solid #e2e8f0;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            thead {
                background-color: #edf2f7;
            }

            th {
                padding: 15px;
                text-align: left;
                font-weight: 600;
                color: #4a5568;
                font-size: 14px;
                border-bottom: 2px solid #e2e8f0;
            }

            td {
                padding: 15px;
                border-bottom: 1px solid #e2e8f0;
                font-size: 14px;
            }

            tbody tr:hover {
                background-color: #f7fafc;
            }

            .status-low {
                color: #38a169;
                font-weight: 500;
            }

            .status-medium {
                color: #d69e2e;
                font-weight: 500;
            }

            .status-high {
                color: #e53e3e;
                font-weight: 500;
            }

            .no-data {
                text-align: center;
                padding: 40px;
                color: #718096;
                font-style: italic;
            }

            @media (max-width: 768px) {
                .filter-grid {
                    grid-template-columns: 1fr;
                }

                .button-group {
                    flex-direction: column;
                }

                .btn {
                    width: 100%;
                }

                table {
                    display: block;
                    overflow-x: auto;
                }
            }
        </style>
    </head>

    <body>
        <div class="container">
            <header>
                <h1>Sensor Data Dashboard</h1>
                <div class="subtitle">Monitor and filter sensor light readings in real-time</div>
            </header>

            <section class="filter-section">
                <form id="filterForm" method="get" action="/api/data/getData">
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="sensor_id">Sensor ID</label>
                            <input type="number" id="sensor_id" name="sensor_id" min="1" placeholder="Enter sensor ID">
                        </div>

                        <div class="filter-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" name="date">
                        </div>

                        <div class="filter-group">
                            <label for="level">Light Level</label>
                            <select id="level" name="level">
                                <option value="">All Levels</option>
                                <option value="low">Low (0 - 1000 lx)</option>
                                <option value="medium">Medium (1000 - 10000 lx)</option>
                                <option value="high">High (> 10000 lx)</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label>Sort By</label>
                            <div class="multiselect-container">
                                <div class="multiselect-header" id="sortHeader">Select options</div>
                                <div class="multiselect-options" id="sortOptions">
                                    <label class="multiselect-option">
                                        <input type="checkbox" value="date">
                                        Date
                                    </label>
                                    <label class="multiselect-option">
                                        <input type="checkbox" value="time">
                                        Time
                                    </label>
                                    <label class="multiselect-option">
                                        <input type="checkbox" value="light">
                                        Light Value
                                    </label>
                                </div>
                                <!-- Hidden input for form submission -->
                                <select id="sortInput" name="sort" multiple style="display: none;">
                                    <option value="date">Date</option>
                                    <option value="time">Time</option>
                                    <option value="light">Light Value</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        <button type="button" class="btn btn-export" id="exportCsvBtn">Export CSV</button>
                        <button type="button" class="btn btn-secondary" id="resetBtn">Reset Filters</button>
                    </div>
                </form>
            </section>

            <section class="table-container">
                <table id="sensorTable">
                    <thead>
                        <tr>
                            <th>Sensor ID</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Light Level (lx)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <%c++ for(auto row:data){ %>
                            <tr>
                                <td>{% row["sensor_id"] %}</td>
                                <td>{% row["date"] %}</td>
                                <td>{% row["time"] %}</td>
                                <td>{% row["light"] %}</td>
                            </tr>
                            <%c++ } %>

                    </tbody>
                </table>
            </section>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Multiselect functionality
                const sortHeader = document.getElementById('sortHeader');
                const sortOptions = document.getElementById('sortOptions');
                const sortCheckboxes = sortOptions.querySelectorAll('input[type="checkbox"]');
                const sortInput = document.getElementById('sortInput');
                const resetBtn = document.getElementById('resetBtn');
                const exportCsvBtn = document.getElementById('exportCsvBtn');
                const filterForm = document.getElementById('filterForm');
                const tableBody = document.getElementById('tableBody');

                // Toggle multiselect dropdown
                sortHeader.addEventListener('click', function (e) {
                    e.stopPropagation();
                    sortOptions.classList.toggle('active');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function () {
                    sortOptions.classList.remove('active');
                });

                // Prevent dropdown close when clicking inside
                sortOptions.addEventListener('click', function (e) {
                    e.stopPropagation();
                });

                // Handle checkbox changes
                sortCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function () {
                        updateSortDisplay();
                        updateSortInput();
                        sortTable();
                    });
                });

                // Reset button functionality
                resetBtn.addEventListener('click', function () {
                    // Reset form inputs
                    filterForm.reset();

                    // Reset sort checkboxes
                    sortCheckboxes.forEach(cb => cb.checked = false);

                    // Reset sort display
                    sortHeader.textContent = 'Select options';

                    // Reset sort input
                    Array.from(sortInput.options).forEach(option => option.selected = false);

                    // Reset table sorting
                    resetTable();

                    // Optional: Clear URL parameters without reloading
                    window.history.replaceState({}, document.title, window.location.pathname);
                });

                // Export CSV file function
                exportCsvBtn.addEventListener('click', function () {
                    updateSortInput();

                    const formData = new FormData(filterForm);
                    const params = new URLSearchParams();

                    for (let [key, value] of formData.entries()) {
                        if (value) {
                            if (key === 'sort') {
                                // sort là multiple
                                const existing = params.get('sort');
                                params.set('sort', existing ? `${existing},${value}` : value);
                            } else {
                                params.append(key, value);
                            }
                        }
                    }

                    window.location.href = "/api/data/exportCsv?" + params.toString();
                });

                // Form submission handler (for demo purposes)
                filterForm.addEventListener('submit', function (e) {
                    // Update hidden sort input before submission
                    updateSortInput();

                    // Get form data
                    const formData = new FormData(filterForm);
                    const params = new URLSearchParams();

                    // Build query string
                    for (let [key, value] of formData.entries()) {
                        if (value) {
                            if (key === 'sort') {
                                // Handle multiple sort values
                                const existing = params.get('sort');
                                params.set('sort', existing ? `${existing},${value}` : value);
                            } else {
                                params.append(key, value);
                            }
                        }
                    }

                    // For demo: show what would be submitted
                    console.log('Submitting with params:', params.toString());

                    // In real implementation, you would:
                    // 1. Make an AJAX request to /api/data/getData
                    // 2. Update table with response data

                    // Demo: simulate API call with timeout
                    simulateApiCall(params);

                    // To actually submit the form, uncomment:
                    this.submit();
                });

                // Helper functions
                function updateSortDisplay() {
                    const selected = Array.from(sortCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.parentElement.textContent.trim());

                    sortHeader.textContent = selected.length > 0 ? selected.join(', ') : 'Select options';
                }

                function updateSortInput() {
                    // Clear all selections
                    Array.from(sortInput.options).forEach(option => {
                        option.selected = false;
                    });

                    // Set selected options
                    sortCheckboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            const option = Array.from(sortInput.options).find(opt => opt.value === checkbox.value);
                            if (option) option.selected = true;
                        }
                    });
                }

                function sortTable() {
                    const selectedSorts = Array.from(sortCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    if (selectedSorts.length === 0) {
                        resetTable();
                        return;
                    }

                    const rows = Array.from(tableBody.querySelectorAll('tr'));

                    rows.sort((a, b) => {
                        const aCells = a.querySelectorAll('td');
                        const bCells = b.querySelectorAll('td');

                        for (let sortBy of selectedSorts) {
                            let comparison = 0;

                            switch (sortBy) {
                                case 'date':
                                    comparison = new Date(aCells[1].textContent) - new Date(bCells[1].textContent);
                                    break;
                                case 'time':
                                    comparison = aCells[2].textContent.localeCompare(bCells[2].textContent);
                                    break;
                                case 'light':
                                    const aValue = parseFloat(aCells[3].textContent.replace(',', ''));
                                    const bValue = parseFloat(bCells[3].textContent.replace(',', ''));
                                    comparison = aValue - bValue;
                                    break;
                            }

                            if (comparison !== 0) return comparison;
                        }

                        return 0;
                    });

                    // Reorder rows
                    tableBody.innerHTML = '';
                    rows.forEach(row => tableBody.appendChild(row));
                }

                function resetTable() {
                    // In a real app, you would reload original data from server
                    // For demo, we'll just re-sort by sensor ID
                    const rows = Array.from(tableBody.querySelectorAll('tr'));
                    rows.sort((a, b) => {
                        const aId = parseInt(a.querySelector('td').textContent);
                        const bId = parseInt(b.querySelector('td').textContent);
                        return aId - bId;
                    });

                    tableBody.innerHTML = '';
                    rows.forEach(row => tableBody.appendChild(row));
                }

                // Demo function to simulate API call
                function simulateApiCall(params) {
                    // Show loading state
                    const submitBtn = filterForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Loading...';
                    submitBtn.disabled = true;

                    // Simulate API delay
                    setTimeout(() => {
                        // Update table with filtered data (demo)
                        const filteredRows = filterTableData(params);
                        updateTable(filteredRows);

                        // Restore button state
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;

                        // Show notification
                        showNotification(`Applied filters: ${getFilterSummary(params)}`);
                    }, 800);
                }

                // Demo data filtering (in real app, this would be server-side)
                function filterTableData(params) {
                    const allRows = Array.from(tableBody.querySelectorAll('tr'));
                    const sensorId = params.get('sensor_id');
                    const date = params.get('date');
                    const level = params.get('level');

                    return allRows.filter(row => {
                        const cells = row.querySelectorAll('td');
                        const rowSensorId = cells[0].textContent;
                        const rowDate = cells[1].textContent;
                        const rowLight = parseFloat(cells[3].textContent.replace(',', ''));

                        // Filter by sensor ID
                        if (sensorId && rowSensorId !== sensorId) return false;

                        // Filter by date
                        if (date && rowDate !== date) return false;

                        // Filter by level
                        if (level) {
                            if (level === 'low' && rowLight >= 1000) return false;
                            if (level === 'medium' && (rowLight < 1000 || rowLight > 10000)) return false;
                            if (level === 'high' && rowLight <= 10000) return false;
                        }

                        return true;
                    });
                }

                function updateTable(rows) {
                    tableBody.innerHTML = '';
                    if (rows.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="no-data">No data matching the selected filters</td></tr>';
                    } else {
                        rows.forEach(row => tableBody.appendChild(row.cloneNode(true)));
                    }
                }

                function getFilterSummary(params) {
                    const filters = [];
                    if (params.get('sensor_id')) filters.push(`Sensor ID: ${params.get('sensor_id')}`);
                    if (params.get('date')) filters.push(`Date: ${params.get('date')}`);
                    if (params.get('level')) filters.push(`Level: ${params.get('level')}`);
                    if (params.get('sort')) filters.push(`Sort: ${params.get('sort')}`);
                    return filters.length > 0 ? filters.join(', ') : 'All data';
                }

                function showNotification(message) {
                    // Create notification element
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4299e1;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 4px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                `;
                    notification.textContent = message;

                    document.body.appendChild(notification);

                    // Remove after 3 seconds
                    setTimeout(() => {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);

                    // Add CSS animation
                    if (!document.querySelector('#notification-styles')) {
                        const style = document.createElement('style');
                        style.id = 'notification-styles';
                        style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes slideOut {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(100%); opacity: 0; }
                        }
                    `;
                        document.head.appendChild(style);
                    }
                }

                // Initialize
                updateSortDisplay();
            });
        </script>
    </body>

</html>